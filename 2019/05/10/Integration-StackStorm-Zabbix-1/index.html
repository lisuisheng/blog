<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Lsuis的博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://lisuisheng.github.io/blog">
    <!--SEO-->

    <meta name="keywords" content="null">


    <meta name="description" content="StackStorm安装与配置环境配置系统要求StackStorm对系统的要求非常严格，目前支持的操作系统及版本如下表所示：



Linux
Vagrant Box
Amazon AWS AM...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>StackStorm安装及与Zabbix平台集成 | Lsuis的博客</title>


    <link rel="alternate" href="/atom.xml" title="Lsuis的博客" type="application/atom+xml">


    <link rel="icon" href="/blog/favicon.ico">

    



<link rel="stylesheet" href="/blog/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/blog/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/blog/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>






    

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header" style="background-image:url(http://snippet.shenliyang.com/img/banner2.jpg)">
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="Lsuis">
            <img src="/blog/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 欢迎来到Lsuis的博客 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://lisuisheng.github.io/blog">Lsuis的博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/blog/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/blog/categories/技术/"><i class="fa "></i>技术</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/blog/categories/随笔/"><i class="fa "></i>随笔</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/blog/categories/区块链/"><i class="fa "></i>区块链</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/blog/archives/"><i class="fa "></i>时间轴</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="StackStorm安装及与Zabbix平台集成">
            
	            StackStorm安装及与Zabbix平台集成
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/blog/categories/技术/">技术</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/05/10</span>
        </span>
        
    
</div>
            
            
    </div>
    
    <div class="post-body post-content">
        <h2 id="StackStorm安装与配置"><a href="#StackStorm安装与配置" class="headerlink" title="StackStorm安装与配置"></a>StackStorm安装与配置</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><h4 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h4><p>StackStorm对系统的要求非常严格，目前支持的操作系统及版本如下表所示：</p>
<table>
<thead>
<tr>
<th>Linux</th>
<th>Vagrant Box</th>
<th>Amazon AWS AMI</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ubuntu 14.04</td>
<td>bento/ubuntu-14.04</td>
<td>Ubuntu Server 14.04 LTS(HVM)</td>
</tr>
<tr>
<td>Ubuntu 16.04</td>
<td>bento/ubuntu-16.04</td>
<td>Ubuntu 16.04 LTS - Xenial(HVM)</td>
</tr>
<tr>
<td>RHEL7/CentOS 7</td>
<td>bento/centos-7.2</td>
<td>Red Hat Enterprise Linux(RHEL) 7.2 (HVM)</td>
</tr>
<tr>
<td>RHEL6/CentOS 6</td>
<td>bento/centos-6.7</td>
<td>Red Hat Enterprise Linux (RHEL) 6 (HVM)</td>
</tr>
</tbody>
</table>
<p>这里我们选用了CentOS 7 作为主机的操作系统。</p>
<h4 id="端口占用"><a href="#端口占用" class="headerlink" title="端口占用"></a>端口占用</h4><p>默认情况下，StackStorm 和相关服务将使用下面这些 TCP 端口:</p>
<ul>
<li>nginx (80, 443)</li>
<li>mongodb (27017)</li>
<li>rabbitmq (4369, 5672, 25672) </li>
<li>postgresql (5432)</li>
<li>st2auth (9100)</li>
<li>st2api (9101)</li>
<li>st2stream (9102)</li>
</ul>
<h4 id="软件依赖"><a href="#软件依赖" class="headerlink" title="软件依赖"></a>软件依赖</h4><p>必须的依赖软件包括 RabbitMQ、MongoDB、PostgreSQL，可选的依赖软件如下:</p>
<ul>
<li>nginx 用于 SSL 终结、反向代理 API 端点和服务</li>
<li>并发策略(Policies)使用的 Redis 或者 Zookeeper </li>
<li>Extreme Workflow Composer 中 LDAP 认证的 LDAP</li>
</ul>
<h3 id="安装方法"><a href="#安装方法" class="headerlink" title="安装方法"></a>安装方法</h3><p>StackStorm提供多种手动安装的方式，可按照个人定制需求选择特定的安装方式。不需要特制需求的，可采用单行安装的方式。这里我们采用这种快速安装的方法来安装StackStorm。</p>
<ol>
<li><p>安装curl，使用如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install curl nss</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行以下命令下载StackStorm的安装脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://stackstorm.com/packages/install.sh | bash -s -- --user=st2admin -- password=&apos;Ch@ngeMe&apos;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>脚本将自动下载并安装StackStorm，完成后可通过浏览器访问WebUI。在CentOS 7 上有可能因为防火墙问题导致访问失败，需要对防火墙做一些设置。</p>
<h3 id="StackStorm配置"><a href="#StackStorm配置" class="headerlink" title="StackStorm配置"></a>StackStorm配置</h3><p>StackStorm 配置文件位于/etc/st2/st2.conf</p>
<p>一般使用默认的配置即可，如需特定配置可参考官方文档。</p>
<h2 id="StackStorm与Zabbix集成"><a href="#StackStorm与Zabbix集成" class="headerlink" title="StackStorm与Zabbix集成"></a>StackStorm与Zabbix集成</h2><h3 id="StackStorm与Zabbix集成创建和配置"><a href="#StackStorm与Zabbix集成创建和配置" class="headerlink" title="StackStorm与Zabbix集成创建和配置"></a>StackStorm与Zabbix集成创建和配置</h3><p>在StackStorm上集成Zabbix需要用到官方提供的集成包，集成包的<a href="https://github.com/StackStorm-Exchange/stackstorm-zabbix" target="_blank" rel="noopener">github仓库</a>，下载后我们根据提供的指南进行安装和配置。</p>
<h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><p>执行下面的命令，安装zabbix的集成包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># st2 pack install zabbix</span><br></pre></td></tr></table></figure></p>
<h4 id="注册StackStorm的报警媒介"><a href="#注册StackStorm的报警媒介" class="headerlink" title="注册StackStorm的报警媒介"></a>注册StackStorm的报警媒介</h4><p>在包内提供的虚拟环境下执行 register_st2_config_to_zabbix.py 脚本，脚本会在zabbix平台上自动注册一个新的报警媒介（即在zabbix的平台上添加一个stackstorm的报警媒介）。中括号部分请将其换成自己安装zabbix的host的地址：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># /opt/stackstorm/virtualenvs/zabbix/bin/python /opt/stackstorm/packs/zabbix/tools/register_st2_config_to_zabbix.py -z [http://zabbix-host/zabbix] -u Admin -p zabbix</span><br></pre></td></tr></table></figure></p>
<p>当我们执行完这个脚本后，在zabbix的WebUI上面，点击“管理-&gt;报警媒介类型”后，可发现在列表的最下方StackStorm的报警媒介已经创建成功了。<br><img src="/blog/img/Zabbix&amp;St2_integration_1.png" alt="images"></p>
<h4 id="配置报警媒介"><a href="#配置报警媒介" class="headerlink" title="配置报警媒介"></a>配置报警媒介</h4><p>点击StackStorm，进入后我们看到如下的配置参数的页面：<br>每一栏的参数的意义如下：</p>
<ul>
<li>Name： 媒介名</li>
<li>Script： 媒介类型</li>
<li>Script Name： 脚本名</li>
<li>Script parameters: 脚本参数<br>在脚本参数中，{ALERT.SENDTO}、{ALERT.SUBJECT}、{ALERT.MESSAGE}这三个参数已经配好了，我们需要配置的是前面4个带有 CHANGE ME 字样的参数，第一个参数是stackstorm的api地址，第二个参数是认证的地址，这两个参数都可以在 <strong>/etc/st2/st2.conf</strong> 配置文件中找到。第三个、第四个参数分别是登录StackStorm的用户名和密码，将其填写上去就可以了。这里给出一个参考配置如下：<br><img src="/blog/img/Zabbix&amp;St2_integration_2.png" alt="images"></li>
</ul>
<h4 id="设置报警脚本"><a href="#设置报警脚本" class="headerlink" title="设置报警脚本"></a>设置报警脚本</h4><p>st2_dispatch.py 这个脚本会将Zabbix上的事件转发到StackStorm的服务器上。我们需要把这个脚本放到 Zabbix 媒介类型所映射的目录中。<br>可通过以下命令查找 Zabbix 的目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># grep &apos;AlertScriptsPath&apos; /etc/zabbix/zabbix_server.conf</span><br></pre></td></tr></table></figure></p>
<p>经查找，报警脚本在Zabbix中存放的目录是：<strong>/usr/lib/zabbix/alertscripts</strong></p>
<p>接下来会出现两种的设置方式，如果安装的 Zabbix 和 StackStorm 在同一个主机上，我们使用以下命令将这个转发信息的脚本复制过去就行了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cp /opt/stackstorm/packs/zabbix/tools/scripts/st2_dispatch.py /usr/lib/zabbix/alertscripts/</span><br></pre></td></tr></table></figure></p>
<p>如果不是安装在同一个主机上的话，需要将脚本发送过去：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># scp st2-node:/opt/stackstorm/packs/zabbix/tools/scripts/st2_dispatch.py ./</span><br><span class="line"># mv st2_dispatch.py /usr/lib/zabbix/alertscripts/</span><br></pre></td></tr></table></figure></p>
<p>按照不同情况将脚本放到对应的路径之后，我们需要设置脚本的执行环境，这里需要用到Python的包管理器 pip ，用 pip 为报警脚本的下载对应的依赖包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># pip install st2client</span><br></pre></td></tr></table></figure></p>
<p>安装好依赖后，对其配置参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># /usr/lib/zabbix/alertscripts/st2_dispatch.py \</span><br><span class="line">&gt; --st2-userid=st2admin \</span><br><span class="line">&gt; --st2-passwd=passwd \</span><br><span class="line">&gt; --st2-api-url=https://st2-node/api \</span><br><span class="line">&gt; --st2-auth-url=https://st2-node/auth</span><br></pre></td></tr></table></figure></p>
<p>userid、passwd参数对应StackStorm的用户名和密码。api-url和auth-url与刚刚在Zabbix平台上报警媒介页面上面的设置成一样。到了这一步，StackStorm和Zabbix的集成基本上就配置完成了。</p>
<h3 id="完善Zabbix的触发警报和转发设置"><a href="#完善Zabbix的触发警报和转发设置" class="headerlink" title="完善Zabbix的触发警报和转发设置"></a>完善Zabbix的触发警报和转发设置</h3><p>我们可以在Zabbix的平台上，点击“配置 -&gt; 动作”，找到“Dispatching to StackStorm”这个Action，点击名字我们可以对其做一些配置。</p>
<p>我们可以对其增加一些触发条件，当满足出发条件之后，会将警报转发到StackStorm上。这里我定义了一个触发条件：<em>触发器示警度 不等于 未分类</em> 。意思是只要警报的类别不是“未分类”都将触发转发的动作。我们可以产生一些警报，测试一下能否触发警报并转发到StackStorm上。<br><img src="/blog/img/Zabbix&amp;St2_integration_6.png" alt="images"><br>点击“配置 -&gt; 主机”，然后找到默认配置好的主机 Zabbix server，点击触发器。<br><img src="/blog/img/Zabbix&amp;St2_integration_7.png" alt="images"></p>
<p>进入触发器页面后，点击右上角的“创建触发器”进入创建页面。</p>
<p>在这里，我们给触发器起个名字，严重性选择除了“未分类”以外的任意一个。在表达式那里，点击右边的“添加”按钮。这里创建的表达式可以任意，只要满足条件触发警报即可。这里给出一个样例配置图：<br><img src="/blog/img/Zabbix&amp;St2_integration_9.png" alt="images"><br>然后，点击最下方的“添加”按钮，这样就成功创建了一个警报的触发器。约等待30秒之后，Zabbix平台会监控到这个警报的产生。我们返回到“监测 -&gt; 仪表板”页面。在“问题”那一栏会产生警报，同时在最后一列会有动作的触发，把鼠标移上去可以看到Zabbix向StackStorm转发了这个错误警告：<br><img src="/blog/img/Zabbix&amp;St2_integration_10.png" alt="images"><br>接下来我们打开StackStorm的WebUI，打开“Trigger”页面，在右侧栏找到”Zabbix -&gt; event_handler”。点击后，打开“INSTANCE”选项卡，点击第一条记录，我们就可以查询到刚刚Zabbix转发的那条报警记录。<br><img src="/blog/img/Zabbix&amp;St2_integration_11.png" alt="images"><br>至此，大概 StackStorm 和 Zabbix 的集成介绍也差不多了。当然，我们也可以在 StackStorm 上设置一些rules。例如，当刚刚 StackStorm 的 Trigger 接收到 Zabbix 之后，触发 rules 里面的某条规则，执行相对应的 Action。这里，提供一个样例：</p>
<ul>
<li>在 rules 中添加一条规则，内容是：当 Trigger 接收到Zabbix转发的报警后，执行一个 Action ，这个 Action 操作的内容是获取 Zabbix 主机的状态信息。（这个 Action 由集成包提供）如图：<br><img src="/blog/img/Zabbix&amp;St2_integration_12.png" alt="images"></li>
<li>再次模拟一次以上触发警报的过程，当 StackStorm 再次接收到警报后，执行 Action 获取主机状态。最后，状态获取这个Action执行的记录，可以在 “HISTORY” 中查到，如图：<br><img src="/blog/img/Zabbix&amp;St2_integration_13.png" alt="images"><br><img src="/blog/img/Zabbix&amp;St2_integration_14.png" alt="images"></li>
</ul>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">Lsuis</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
    
        <a href="/blog/2019/05/10/Integration-StackStorm-Zabbix/" class="next-post btn btn-default" title="Zabbix安装和简单配置（Zabbix v4.2, CentOS 7）">
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">Zabbix安装和简单配置（Zabbix v4.2, CentOS 7）</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/blog/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'LFKuM1kEs9n3Oh6qvG9kxo8d-gzGzoHsz',
            appKey: 'XyB4N0A5K2TqfScBxDtNPXKg',
            placeholder: '说点什么吧',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#StackStorm安装与配置"><span class="toc-text">StackStorm安装与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境配置"><span class="toc-text">环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#系统要求"><span class="toc-text">系统要求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#端口占用"><span class="toc-text">端口占用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#软件依赖"><span class="toc-text">软件依赖</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装方法"><span class="toc-text">安装方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StackStorm配置"><span class="toc-text">StackStorm配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StackStorm与Zabbix集成"><span class="toc-text">StackStorm与Zabbix集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#StackStorm与Zabbix集成创建和配置"><span class="toc-text">StackStorm与Zabbix集成创建和配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#下载安装"><span class="toc-text">下载安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注册StackStorm的报警媒介"><span class="toc-text">注册StackStorm的报警媒介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置报警媒介"><span class="toc-text">配置报警媒介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置报警脚本"><span class="toc-text">设置报警脚本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#完善Zabbix的触发警报和转发设置"><span class="toc-text">完善Zabbix的触发警报和转发设置</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2017
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>







<script src="/blog/js/app.js?rev=@@hash"></script>

</body>
</html>